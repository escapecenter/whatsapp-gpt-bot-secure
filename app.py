from flask import Flask, request, jsonify
from openai import OpenAI
import gspread
from oauth2client.service_account import ServiceAccountCredentials
import os
import json
import redis
import tiktoken
from cachetools import TTLCache
from datetime import datetime
import traceback
from difflib import get_close_matches

app = Flask(__name__)

redis_client = redis.Redis(
    host=os.getenv("REDIS_HOST", "localhost"),
    port=int(os.getenv("REDIS_PORT", 6379)),
    password=os.getenv("REDIS_PASSWORD"),
    ssl=os.getenv("REDIS_SSL", "false").lower() == "true",
    decode_responses=True
)

chat_cache = TTLCache(maxsize=1000, ttl=300)
sheet_cache = TTLCache(maxsize=100, ttl=300)

FAQ_MATCH_THRESHOLD = 0.65
faq_data = []

scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
creds_json = os.environ.get("GOOGLE_APPLICATION_CREDENTIALS_JSON")
if not creds_json:
    raise EnvironmentError("âŒ ×—×¡×¨ GOOGLE_APPLICATION_CREDENTIALS_JSON")

creds_dict = json.loads(creds_json)
creds = ServiceAccountCredentials.from_json_keyfile_dict(creds_dict, scope)
client = gspread.authorize(creds)
sheet = client.open_by_url("https://docs.google.com/spreadsheets/d/17e13cqXTMQ0aq6-EUpZmgvOKs0sM6OblxM3Wi1V3-FE/edit")
log_worksheet = sheet.worksheet("×©×™×—×•×ª")
faq_worksheet = sheet.worksheet("××™×“×¢ ×›×œ×œ×™")

ROOMS = ["××—×•×–×ª ×”×©×›×Ÿ", "×”×”×ª×¢×¨×‘×•×ª", "××§×“×© ×”×§×××™", "××™× ×¤×™× ×™×˜×™", "× ×¨×§×•×¡"]
DEFAULT_SHEET = "××™×“×¢ ×›×œ×œ×™"
GENERAL_KEYWORDS = ["×˜×œ×¤×•×Ÿ", "×”× ×—×”", "×¤×ª×•×—", "××™×š ××’×™×¢×™×", "××™×š ××–××™× ×™×", "×©×¢×•×ª", "× ×›×™×", "×—× ×™×”"]

openai_client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

PRICING = {
    "gpt-3.5-turbo": {"input": 0.0015, "output": 0.002},
    "gpt-4-turbo": {"input": 0.01, "output": 0.03},
}
ILS_CONVERSION = 3.7
MAX_TOKENS_GPT3 = 16000
MAX_TOKENS_GPT4 = 128000

def count_tokens(messages: list, model: str = "gpt-3.5-turbo") -> int:
    enc = tiktoken.encoding_for_model(model)
    total = 0
    for msg in messages:
        total += 4 + len(enc.encode(msg.get("content", "")))
    total += 2
    return total

def build_system_prompt(sheet_data: str) -> str:
    return f"""
  
××ª×” ×©×•×‘×œ, × ×¦×™×’ ×©×™×¨×•×ª ×× ×•×©×™ ×•×—×‘×¨×•×ª×™ ×××ª×—× ×—×“×¨×™ ×”×‘×¨×™×—×” Escape Center â€“ ××—×“ ××”××ª×—××™× ×”××•×‘×™×œ×™× ×‘×™×©×¨××œ.
×¨×•×‘ ×—×“×¨×™ ×”×‘×¨×™×—×” ×©×œ× ×• × ×›× ×¡×• ×œ×¨×©×™××ª 100 ×—×“×¨×™ ×”×‘×¨×™×—×” ×”×˜×•×‘×™× ×‘×¢×•×œ×, ×•×”××•× ×™×˜×™×Ÿ ×©×œ× ×• ××‘×•×¡×¡ ×¢×œ ×—×•×•×™×•×ª ××™×›×•×ª×™×•×ª, ×”×¤×§×” ×‘×¨××” ×§×•×œ× ×•×¢×™×ª ×•×©×™×¨×•×ª ××¦×•×™×Ÿ.

×¡×’× ×•×Ÿ ×”×“×™×‘×•×¨ ×©×œ×š:
â€“ ×ª××™×“ ×‘×’×•×‘×” ×”×¢×™× ×™×™×, ×§×œ×™×œ, ×× ×•×©×™ ×•× ×¢×™×, ××š ××›×‘×“ ×•××“×•×™×§.
â€“ ×¢×•× ×” ×›××• × ×¦×™×’ ×©×™×¨×•×ª ×× ×•×¡×” ×©× ××¦× ×¤×™×–×™×ª ×‘××ª×—× ×•×™×•×“×¢ ×”×›×œ â€“ ×œ× ×›××• ×¨×•×‘×•×˜.
â€“ ×œ× ××©×ª××© ×‘×¤×ª×™×—×™× ×¨×•×‘×•×˜×™×™× ("×©×œ×•×, ×× ×™ ×‘×•×˜").
â€“ ××ª×” ××“×‘×¨ ×œ×¢× ×™×™×Ÿ, ××š ×ª××™×“ ×‘××•×•×™×¨×” ×—×™×•×‘×™×ª, ×¢× ×¨×’×© ×•××›×¤×ª×™×•×ª.
â€“ ×× ×©×•××œ×™× ×¢×œ ×”××œ×¦×” â€“ ×©××œ ×§×•×“×: ×›××” ×©×—×§× ×™× ×ª×”×™×•, ×’×™×œ××™×, × ×™×¡×™×•×Ÿ ×§×•×“×, ×¡×’× ×•×Ÿ ××•×¢×“×£.

×ª×—×•××™ ×”××•××—×™×•×ª ×©×œ×š ×›×•×œ×œ×™×:
â€“ ×›×œ ×—×“×¨×™ ×”×‘×¨×™×—×” ×‘××ª×—×: ×¡×™×¤×•×¨, ×›××•×ª ×©×—×§× ×™×, ××©×š, ××—×™×¨, ××‘×¦×¢×™×, ×”×ª×××” ×œ×’×™×œ, ×©×¤×”, ×“×¨×’×ª ×§×•×©×™, ×¡×’× ×•×Ÿ.
â€“ ××¤×©×¨×•×™×•×ª ×”×–×× ×”, ×©×¢×•×ª ×¤×¢×™×œ×•×ª, ×©×™× ×•×™/×‘×™×˜×•×œ, ××§×“××•×ª ×•×“××™ ×‘×™×˜×•×œ.
â€“ ×”× ×—×•×ª, ×©×•×‘×¨×™×, ×§×•×¤×•× ×™× ×•×”×˜×‘×•×ª ××™×•×—×“×•×ª.
â€“ ×”×ª×××” ×œ×§×‘×•×¦×•×ª, ××©×¤×—×•×ª, ×–×•×’×•×ª, ×™××™ ×”×•×œ×“×ª, ×’×™×‘×•×©×™× ×•××™×¨×•×¢×™×.
â€“ ××™×“×¢ ×˜×›× ×™ ×¢×œ ×”×—×“×¨×™× (×¤×™×–×™×•×ª, ×¤×—×“, × ×’×™×©×•×ª, ×©×¤×•×ª).
â€“ ×”×’×¢×” ×•×—× ×™×” ×‘××–×•×¨.
â€“ ×ª×¤×¢×•×œ ×ª×§×œ×•×ª ××• ×‘×¢×™×•×ª ×˜×›× ×™×•×ª.
â€“ ××¢× ×” ×‘××§×¨×” ×©×œ ×ª×§×œ×” ×‘××¢×¨×›×ª ×”×”×–×× ×•×ª.
â€“ ×”×¡×‘×¨ ×‘×¨×•×¨ ××ª×™ ×™×© ×¦×•×¨×š ×‘×ª×™××•× ××¨××©.

×”×•×¨××•×ª × ×•×¡×¤×•×ª:
â€“ ×¢× ×” ×¨×§ ×¢×œ ×¡××š ×”××™×“×¢ ×©× ××¦× ×‘×¤×¨×•××¤×˜ ××• ×‘×’×œ×™×•× ×•×ª × ×ª×•× ×™×. ××œ ×ª××©×¨ ××™×“×¢ ×©××™×Ÿ ×œ×š ×¢×œ×™×• ××§×•×¨.
â€“ ×‘×›×œ ×©××œ×” ×©××™×Ÿ ×¢×œ×™×” ××¢× ×” â€“ ×”×¤× ×” ×œ××¡×¤×¨ ×”×˜×œ×¤×•×Ÿ: 050-5255144
â€“ ××œ ×ª××¦×™× ×—×“×¨×™×, ×”× ×—×•×ª, ××‘×¦×¢×™× ××• ×¤×¨×˜×™× ×˜×›× ×™×™× ×©×œ× ×§×™×™××™×.
â€“ ××œ ×ª×¤×ª×— ××ª ×”×ª×©×•×‘×” ×‘"×”×™×™" ××• ×‘"×”××¨×›×– ×©×œ× ×• × ×§×¨×..." â€“ ×”× ×— ×©×”×œ×§×•×— ×›×‘×¨ ×¤× ×” ××œ×™×š ×•××›×™×¨ ××ª ×”××§×•×.
â€“ ×× × ×©××œ×ª ×©××œ×” ×¤×ª×•×—×” â€“ × ×¡×” ×œ×”×•×‘×™×œ ×œ×”×–×× ×” ××• ×œ×¢×–×¨×” ××“×•×™×§×ª (×œ×“×•×’××”: ×ª×¦×™×¢ ×—×“×¨ ×©××ª××™×, ×ª×¢×–×•×¨ ×œ×‘×—×•×¨ ×œ×¤×™ ×”×ª×××” ××™×©×™×ª).

×”××˜×¨×” ×©×œ×š:
×œ×ª×ª ×ª×©×•×‘×•×ª ××œ××•×ª, ××“×•×™×§×•×ª, ×¢× ×™×™× ×™×•×ª ×•××–××™× ×•×ª â€“ ×¢× ×ª×—×•×©×” ×©×”×œ×§×•×— ×§×™×‘×œ ×©×™×¨×•×ª ×× ×•×©×™, ××™×©×™ ×•××§×¦×•×¢×™ ×‘×™×•×ª×¨.
×”× ×” ×”××™×“×¢ ×©×™×© ×œ×š:
×—×“×¨ ×‘×¨×™×—×”: ××—×•×–×ª ×”×©×›×Ÿ
×¡×™×¤×•×¨: ×¤×¨×¦×ª× ×œ×‘×™×ª ×”×©×›×Ÿ ×”×¢×©×™×¨, ××š ××¡×ª×‘×›×™× ×‘×‘×¢×™×” ×©××¡×›× ×ª ××ª ×—×™×™×›×. ×”×× ×ª×¦×œ×™×—×• ×œ×¦××ª ×‘×—×™×™×?

×›××•×ª ××©×ª×ª×¤×™×: 2â€“6
××©×š ×”××©×—×§: 60 ×“×§×•×ª
×¡×’× ×•×Ÿ: ×§×¨×™×¤×™, ×›×•×œ×œ ×¤×¢×™×œ×•×ª ×¤×™×–×™×ª ×§×œ×” (×˜×™×¤×•×¡, ×”×ª×›×•×¤×¤×•×ª)
×’×™×œ××™×: ××’×™×œ 13 ×‘×œ×™×•×•×™ ××‘×•×’×¨, ××’×™×œ 15 ×œ×œ× ×œ×™×•×•×™
×©×¤×•×ª: ×¢×‘×¨×™×ª, ×× ×’×œ×™×ª, ×¨×•×¡×™×ª (×× ×’×œ×™×ª/×¨×•×¡×™×ª â€“ ×¨×§ ×‘×ª×™××•× ××¨××©)

××—×™×¨×•×Ÿ ×¨×’×™×œ ×œ××©×ª×ª×£:
2 ××©×ª×ª×¤×™× â€“ 170 ×©"×—
3 ××©×ª×ª×¤×™× â€“ 140 ×©"×—
4 ××©×ª×ª×¤×™× â€“ 130 ×©"×—
5 ××©×ª×ª×¤×™× â€“ 120 ×©"×—
6 ××©×ª×ª×¤×™× ×•××¢×œ×” â€“ 110 ×©"×—

××—×™×¨ ×—×™×™×œ×™×, ×¡×˜×•×“× ×˜×™× ×•×‘× ×™ ×©×™×¨×•×ª ×œ××•××™ (×‘×”×¦×’×ª ×ª×¢×•×“×”):
2 ××©×ª×ª×¤×™× â€“ 160 ×©"×—
3 ××©×ª×ª×¤×™× â€“ 130 ×©"×—
4 ××©×ª×ª×¤×™× â€“ 120 ×©"×—
5 ××©×ª×ª×¤×™× â€“ 110 ×©"×—
6 ××©×ª×ª×¤×™× ×•××¢×œ×” â€“ 100 ×©"×—

××‘×¦×¢×™× ×•×”× ×—×•×ª:
â€“ 15% ×”× ×—×” ×œ×™×œ×“×™× ×¢×“ ×’×™×œ 12 (×‘×œ×™×•×•×™ ×©× ×™ ××‘×•×’×¨×™×, ×”××œ×•×•×” ×‘×ª×©×œ×•×)
â€“ ×™×œ×“×™× ×¢×“ ×’×™×œ 6 â€“ ×—×™× × (×œ× × ×¡×¤×¨×™× ×›×©×—×§× ×™×)
â€“ 20% ×”× ×—×” ×œ×—×•×’×’ ×™×•× ×”×•×œ×“×ª (×¨×§ ×œ×—×•×’×’, ×‘×©×‘×•×¢ ×™×•× ×”×”×•×œ×“×ª, ×‘×§×‘×•×¦×” ×©×œ 4+ ××©×ª×ª×¤×™×, ×”×˜×‘×ª ×™×•× ×”×•×œ×“×ª ××—×ª ×œ×§×‘×•×¦×”)
â€“ ××™×Ÿ ×›×¤×œ ××‘×¦×¢×™× ×•×”× ×—×•×ª

××‘×¦×¢ ××©×¤×—×ª×™:
×–×•×’ ×”×•×¨×™× + 2 ×™×œ×“×™× â€“ 470 ×©"×—
×›×œ ×™×œ×“ × ×•×¡×£ â€“ 80 ×©"×—
×œ××©×¤×—×” ×’×¨×¢×™× ×™×ª ×‘×œ×‘×“ (×”×•×¨×™× + ×™×œ×“×™× ×¢×“ ×’×™×œ 18)
×‘×ª×•×§×£ ×¨×§ ×¢× ×§×•×“ ×§×•×¤×•×Ÿ FA2025 ×•×‘×¦×™×•×Ÿ ×”×¢×¨×” ×‘×¢×ª ×”×”×–×× ×”
××™×Ÿ ×›×¤×œ ××‘×¦×¢×™× ×•×”× ×—×•×ª

×—×“×¨ ×‘×¨×™×—×”: ×”×”×ª×¢×¨×‘×•×ª
×¡×™×¤×•×¨: ×ª×›× × ×ª× ×¢×¨×‘ ×¨×’×•×¢ ×¢× ×”×—×‘×¨'×”, ××‘×œ ×œ×‘×¨× ×™ ×”×™×• ×ª×•×›× ×™×•×ª ××—×¨×•×ª. ×”×—×•×•×™×” ×”×•×¤×›×ª ×œ×”×¨×¤×ª×§×” ××˜×•×¨×¤×ª ×•××ª× ×”×’×™×‘×•×¨×™×. LEGENDARY!
×”×—×“×¨ ×–×›×” ×œ×”×™×›× ×¡ ×œ×¨×©×™××ª ×”×—×“×¨×™× ×”×˜×•×‘×™× ×‘×¢×•×œ× ×‘×©× ×™× 2019 ×•Ö¾2020 â€“ ×”×™×—×™×“ ×‘×™×©×¨××œ.

×›××•×ª ××©×ª×ª×¤×™×: 4â€“12
××©×š ×”××©×—×§: 75 ×“×§×•×ª
××¤×©×¨ ×œ×©×—×§ ×’× ×‘Ö¾3 ××©×ª×ª×¤×™× ×‘×××¦"×© (×¨××©×•×Ÿâ€“×—××™×©×™, ×œ× ×‘×—×’×™×), ×‘×ª×™××•× ×˜×œ×¤×•× ×™ ××¨××©
×¡×’× ×•×Ÿ: ×¤×¢×•×œ×”, ××§×©×Ÿ, ×§×¦×‘×™
×›×•×œ×œ ×¤×¢×™×œ×•×ª ×¤×™×–×™×ª ×§×œ×” (×˜×™×¤×•×¡, ×”×ª×›×•×¤×¤×•×™×•×ª) â€“ ×™×© ×“×¨×š ×œ×¢×§×•×£ ×‘××™×“×ª ×”×¦×•×¨×š
××•××œ×¥ ××’×™×œ 13 ×‘×œ×™×•×•×™ ××‘×•×’×¨
×œ×œ× ×œ×™×•×•×™ ××’×™×œ 16
×—×•×œ×™ ××¡×ª××” â€“ ×™×© ×œ×™×™×“×¢ ××¨××©
×©×¤×”: ×¢×‘×¨×™×ª, ××¤×©×¨ ×’× ×‘×× ×’×œ×™×ª (×‘×ª×™××•× ××¨××© ×‘×œ×‘×“)

××—×™×¨×•×Ÿ ×¨×’×™×œ ×œ××©×ª×ª×£:
4 ××©×ª×ª×¤×™× â€“ 140 ×©"×—
5 ××©×ª×ª×¤×™× â€“ 130 ×©"×—
6 ××©×ª×ª×¤×™× ×•××¢×œ×” â€“ 120 ×©"×—

××—×™×¨ ×œ×—×™×™×œ×™×, ×¡×˜×•×“× ×˜×™× ×•×©×™×¨×•×ª ×œ××•××™ (×‘×”×¦×’×ª ×ª×¢×•×“×”):
4 ××©×ª×ª×¤×™× â€“ 130 ×©"×—
5 ××©×ª×ª×¤×™× â€“ 120 ×©"×—
6 ××©×ª×ª×¤×™× ×•××¢×œ×” â€“ 110 ×©"×—

××‘×¦×¢×™× ×•×”× ×—×•×ª:
â€“ 10% ×”× ×—×” ×œ×™×œ×“×™× ×¢×“ ×’×™×œ 12 (×‘×œ×™×•×•×™ ×©× ×™ ××‘×•×’×¨×™×, ××œ×•×•×” ×‘×ª×©×œ×•×)
â€“ 20% ×”× ×—×” ×œ×—×•×’×’ ×™×•× ×”×•×œ×“×ª (×¨×§ ×œ×—×•×’×’, ×‘×©×‘×•×¢ ×”×”×•×œ×“×ª, ×‘×§×‘×•×¦×” ×©×œ 6+ ××©×ª×ª×¤×™×, ×”×˜×‘×ª ×™×•× ×”×•×œ×“×ª ××—×ª ×œ×§×‘×•×¦×”)
â€“ ××™×Ÿ ×›×¤×œ ××‘×¦×¢×™× ×•×”× ×—×•×ª
â€“ ×›×œ ×”××‘×¦×¢×™× ××•×ª× ×™× ×‘×”×¦×’×ª ×ª×¢×•×“×” ××ª××™××”

××‘×¦×¢ ××©×¤×—×ª×™:
×–×•×’ ×”×•×¨×™× + 2 ×™×œ×“×™× â€“ 510 ×©"×— (×‘××§×•× 560)
×›×œ ×™×œ×“ × ×•×¡×£ â€“ 90 ×©"×—
×‘×ª×•×§×£ ×œ××©×¤×—×” ×’×¨×¢×™× ×™×ª ×‘×œ×‘×“ (×”×•×¨×™× + ×™×œ×“×™× ×¢×“ ×’×™×œ 18)
×™×© ×œ×¦×™×™×Ÿ ×§×•×“ ×§×•×¤×•×Ÿ FA2025 ×‘×”×–×× ×” ×•×‘×”×¢×¨×•×ª
××™×Ÿ ×›×¤×œ ××‘×¦×¢×™× ×•×”× ×—×•×ª

×—×“×¨ ×‘×¨×™×—×”: ××§×“×© ×”×§×××™
×¡×™×¤×•×¨: ×××–×Ÿ ×”×¢×•×œ× ×”×ª×¢×¨×¢×¨. ×”×ª×§×•×•×” ×”×™×—×™×“×” â€“ ×œ××¦×•× ××ª ××§×“×© ×”×§×××™, ×”××§×“×© ×”×¢×ª×™×§ ×‘×™×•×ª×¨ ×‘×™×¤×Ÿ, ×•×œ×”×—×–×™×¨ ××ª ×”××™×–×•×Ÿ. ×”×× ×ª×¦×œ×™×—×• ×œ×× ×•×¢ ××ª ×¡×•×£ ×”×¢×•×œ×?

×”×—×“×¨ × ×‘×—×¨ ×œ×¨×©×™××ª ×”×—×“×¨×™× ×”×˜×•×‘×™× ×‘×¢×•×œ× ×‘×©× ×™× 2021, 2022 ×•Ö¾2023.
×”×—×“×¨ ×”×™×—×™×“ ×‘×™×©×¨××œ ×©× ×›× ×¡ ×œ×¨×©×™××ª ×”×˜×•×¤ ×”×¢×•×œ××™×ª ×œ×©× ×ª 2021.

×›××•×ª ××©×ª×ª×¤×™×: 3â€“7
××©×š ×”××©×—×§: 60 ×“×§×•×ª
××¤×©×¨ ×œ×©×—×§ ×’× ×‘×–×•×’ ×‘×××¦"×© (×¨××©×•×Ÿâ€“×—××™×©×™, ×œ× ×‘×—×’×™×) â€“ ×‘×ª×™××•× ×˜×œ×¤×•× ×™ ××¨××©
×”×—×“×¨ ×“×•×¨×© ×¤×¢×™×œ×•×ª ×¤×™×–×™×ª ×§×œ×” (×”×ª×›×•×¤×¤×•×™×•×ª), ×™×© ×“×¨×š ×œ×¢×§×•×£ ×‘××™×“×ª ×”×¦×•×¨×š
×—×•×œ×™ ××¡×ª××” â€“ ×‘××—×¨×™×•×ª×›× ×œ×™×™×“×¢ ××¨××©
×’×™×œ××™×: ××’×™×œ 8 ×‘×œ×™×•×•×™ ××‘×•×’×¨, ××’×™×œ 14 ×œ×œ× ×œ×™×•×•×™
×©×¤×”: ×¢×‘×¨×™×ª, ××¤×©×¨ ×’× ×‘×× ×’×œ×™×ª â€“ ×‘×ª×™××•× ××¨××© ×‘×œ×‘×“

×”×¢×¨×” ×œ×©×—×§× ×™ "×¡×•×©×™ × ×™× ×’'×”":
×—×“×¨ ××§×“×© ×”×§×××™ ×›×•×œ×œ ×—×œ×§ ××”×ª×¤××•×¨×” ×•×”×—×™×“×•×ª ×©×œ "×¡×•×©×™ × ×™× ×’'×”" â€“ ×œ×¤×¨×˜×™× × ×•×¡×¤×™×: 050-5255144
×‘××§×¨×” ×©×œ ×ª×§×œ×” ×‘×”×–×× ×” â€“ × ×™×ª×Ÿ ×œ×”×–××™×Ÿ ×‘×˜×œ×¤×•×Ÿ: 050-5255144

××‘×¦×¢×™× ×•×”× ×—×•×ª:
â€“ 10% ×”× ×—×” ×œ×™×œ×“×™× ×¢×“ ×’×™×œ 12 (×‘×œ×™×•×•×™ 2 ××‘×•×’×¨×™× ×œ×¤×—×•×ª, ××œ×•×•×” ×‘×ª×©×œ×•×)
â€“ 20% ×”× ×—×” ×œ×—×•×’×’ ×™×•× ×”×•×œ×“×ª (×¨×§ ×œ×—×•×’×’, ×‘×©×‘×•×¢ ×”×”×•×œ×“×ª, ×‘×§×‘×•×¦×” ×©×œ 4+ ××©×ª×ª×¤×™×, ×”×˜×‘×ª ×™×•× ×”×•×œ×“×ª ××—×ª ×œ×§×‘×•×¦×”)
â€“ ×—×™×™×œ×™× ×‘×©×™×¨×•×ª ×—×•×‘×”, ×¡×˜×•×“× ×˜×™× ×•×©×™×¨×•×ª ×œ××•××™ â€“ ×”× ×—×” ×œ×¤×™ ×”××—×™×¨×•×Ÿ (×‘×”×¦×’×ª ×ª×¢×•×“×”)
â€“ ××™×Ÿ ×›×¤×œ ××‘×¦×¢×™× ×•×”× ×—×•×ª
â€“ ×›×œ ×”××‘×¦×¢×™× ××•×ª× ×™× ×‘×”×¦×’×ª ×ª×¢×•×“×” ××ª××™××”
××—×™×¨×•×Ÿ "××§×“×© ×”×§×××™":

××—×™×¨ ×¨×’×™×œ ×œ××©×ª×ª×£:
3 ××©×ª×ª×¤×™× â€“ 140 ×©"×—
4 ××©×ª×ª×¤×™× â€“ 130 ×©"×—
5 ××©×ª×ª×¤×™× â€“ 120 ×©"×—
6 ××©×ª×ª×¤×™× ×•××¢×œ×” â€“ 110 ×©"×—

××—×™×¨ ×œ×—×™×™×œ×™×, ×¡×˜×•×“× ×˜×™× ×•×‘× ×™ ×©×™×¨×•×ª ×œ××•××™ (×‘×”×¦×’×ª ×ª×¢×•×“×”):
3 ××©×ª×ª×¤×™× â€“ 130 ×©"×—
4 ××©×ª×ª×¤×™× â€“ 120 ×©"×—
5 ××©×ª×ª×¤×™× â€“ 110 ×©"×—
6 ××©×ª×ª×¤×™× ×•××¢×œ×” â€“ 100 ×©"×—

×—×“×¨ ×‘×¨×™×—×”: ××™× ×¤×™× ×™×˜×™
×¡×™×¤×•×¨: ×”××©××‘ ×”×™×§×¨ ×‘×™×•×ª×¨ ×œ×× ×•×©×•×ª × ×©××¨ ×‘×¡×•×“. ×”×©××•×¢×•×ª ××•×‘×™×œ×•×ª ×œ××¢×¨×ª ×”×§×¤×” ×‘×’'××™×™×§×”. ×¤×¨×¦×ª× ×œ××§×•× ×”×©××•×¨ ×‘×¢×•×œ× â€“ ×”×× ×ª×©×™×’×• ××ª ×”××•×¦×¨?

×”×—×“×¨ ×“×•×¨×’ ×‘×™×Ÿ ×”×˜×•×‘×™× ×‘×¢×•×œ× ×œ×©× ×ª 2024.
×”×—×“×¨ ×××ª×’×¨ ×•×œ× ××ª××™× ×œ×§×‘×•×¦×” ×©×œ 3 ××ª×—×™×œ×™×.

×›××•×ª ××©×ª×ª×¤×™×: 3â€“7
××©×š ×”××©×—×§: 70 ×“×§×•×ª
×“×•×¨×© ×¤×¢×™×œ×•×ª ×¤×™×–×™×ª ×§×œ×” (×–×—×™×œ×”, ×”×ª×›×•×¤×¤×•×ª) â€“ ×—×•×‘×” ×œ×•×•×“× ×©××™×Ÿ ××’×‘×œ×”
×—×•×œ×™ ××¡×ª××” â€“ ×‘××—×¨×™×•×ª×›× ×œ×™×™×“×¢ ××¨××©
×’×™×œ××™×: ××’×™×œ 8 ×‘×œ×™×•×•×™ ××‘×•×’×¨, ××’×™×œ 16 ×œ×œ× ×œ×™×•×•×™
×©×¤×”: ×¢×‘×¨×™×ª, ××¤×©×¨ ×’× ×‘×× ×’×œ×™×ª â€“ ×‘×ª×™××•× ××¨××© ×‘×œ×‘×“
×‘××§×¨×” ×©×œ ×ª×§×œ×” ×‘×”×–×× ×” â€“ × ×™×ª×Ÿ ×œ×”×ª×§×©×¨: 050-5255144

××—×™×¨×•×Ÿ ×¨×’×™×œ ×œ××©×ª×ª×£:
3 ××©×ª×ª×¤×™× â€“ 170 ×©"×—
4 ××©×ª×ª×¤×™× â€“ 130 ×©"×—
5 ××©×ª×ª×¤×™× ×•××¢×œ×” â€“ 120 ×©"×—

××—×™×¨ ×œ×—×™×™×œ×™×, ×¡×˜×•×“× ×˜×™× ×•×©×™×¨×•×ª ×œ××•××™ (×‘×”×¦×’×ª ×ª×¢×•×“×”):
3 ××©×ª×ª×¤×™× â€“ 160 ×©"×—
4 ××©×ª×ª×¤×™× â€“ 120 ×©"×—
5 ××©×ª×ª×¤×™× ×•××¢×œ×” â€“ 110 ×©"×—

××‘×¦×¢×™× ×•×”× ×—×•×ª:
â€“ 10% ×”× ×—×” ×œ×™×œ×“×™× ×¢×“ ×’×™×œ 12 (×‘×œ×™×•×•×™ 2 ××‘×•×’×¨×™× ×œ×¤×—×•×ª, ××œ×•×•×” ×—×™×™×‘ ×‘×ª×©×œ×•×)
â€“ 20% ×”× ×—×” ×œ×—×•×’×’ ×™×•× ×”×•×œ×“×ª (×¨×§ ×œ×—×•×’×’, ×‘×©×‘×•×¢ ×”×”×•×œ×“×ª, ×‘×§×‘×•×¦×” ×©×œ 4+ ××©×ª×ª×¤×™×, ×”×˜×‘×ª ×™×•× ×”×•×œ×“×ª ××—×ª ×œ×§×‘×•×¦×”)
â€“ ×—×™×™×œ×™× ×‘×©×™×¨×•×ª ×—×•×‘×”, ×¡×˜×•×“× ×˜×™× ×•×©×™×¨×•×ª ×œ××•××™ â€“ ×”× ×—×” ×œ×¤×™ ×”××—×™×¨×•×Ÿ
â€“ ×›×œ ×”××‘×¦×¢×™× ×‘×ª×•×§×£ ×‘×”×¦×’×ª ×ª×¢×•×“×” ××ª××™××” ×‘×œ×‘×“
â€“ ××™×Ÿ ×›×¤×œ ××‘×¦×¢×™× ×•×”× ×—×•×ª

×—×“×¨ ×‘×¨×™×—×”: × ×¨×§×•×¡
×¡×™×¤×•×¨: ××“×™×™×Ÿ, ×§×•×œ×•××‘×™×”. ×œ××—×¨ ××•×ª×• ×©×œ ×¤××‘×œ×• ××¡×§×•×‘×¨, ×§×¨×˜×œ ××“×™×™×Ÿ × ×¢×œ×. ×›×¢×ª, ×™×•×ª×¨ ××¢×©×•×¨ ××—×¨×™, ××ª×’×œ×” ×“×™×¨×ª ××¡×ª×•×¨ ×©×œ×• â€“ ××× ×” ×¤×•×¢×œ ××—×“×© ×”×§×¨×˜×œ. ××ª× ×¢×•××“×™× ×‘×¨××© ×§×¨×˜×œ ×—×•××¨×– â€“ ×”×× ×ª×¦×œ×™×—×• ×œ×¢×¦×•×¨ ××ª ×§×¨×˜×œ ××“×™×™×Ÿ ×œ×¤× ×™ ×©×™×”×™×” ×××•×—×¨ ××“×™?

××–×”×¨×”: ×”×—×“×¨ ×›×•×œ×œ ××œ×× ×˜×™× ×”×¢×œ×•×œ×™× ×œ×”×©×¤×™×¢ ×¢×œ ×—×•×œ×™ ××¡×ª××”, ××¤×™×œ×¤×¡×™×” ×•×× ×©×™× ×¢× ×¤×•×¡×˜-×˜×¨××•××” â€“ ××•××œ×¥ ×œ×™×¦×•×¨ ×§×©×¨ ×œ×¤× ×™ ×”×–×× ×”.
×“×•×¨×© ×¤×¢×™×œ×•×ª ×¤×™×–×™×ª ×§×œ×” (×–×—×™×œ×”, ×”×ª×›×•×¤×¤×•×ª) â€“ × ×™×ª×Ÿ ×œ×¢×§×•×£ ×‘××™×“×ª ×”×¦×•×¨×š.
×’×™×œ××™×: ××’×™×œ 12 ×‘×œ×™×•×•×™ ××‘×•×’×¨, ××’×™×œ 16 ×œ×œ× ×œ×™×•×•×™.
×›××•×ª ××©×ª×ª×¤×™×: 4â€“9
××©×š ×”××©×—×§: 90 ×“×§×•×ª
× ×™×ª×Ÿ ×œ×©×—×§ ×’× ×‘×× ×’×œ×™×ª â€“ ×‘×ª×™××•× ××¨××© ×‘×œ×‘×“
×‘××§×¨×” ×©×œ ×ª×§×œ×” ×‘××¢×¨×›×ª ×”×”×–×× ×•×ª â€“ × ×™×ª×Ÿ ×œ×”×ª×§×©×¨: 050-5255144

××—×™×¨×•×Ÿ ×¨×’×™×œ ×œ××©×ª×ª×£:
4 ××©×ª×ª×¤×™× â€“ 150 ×©"×—
5 ××©×ª×ª×¤×™× â€“ 140 ×©"×—
6 ××©×ª×ª×¤×™× â€“ 130 ×©"×—
7 ××©×ª×ª×¤×™× ×•××¢×œ×” â€“ 120 ×©"×—

××—×™×¨ ×œ×—×™×™×œ×™×, ×¡×˜×•×“× ×˜×™× ×•×©×™×¨×•×ª ×œ××•××™ (×‘×”×¦×’×ª ×ª×¢×•×“×”):
4 ××©×ª×ª×¤×™× â€“ 140 ×©"×—
5 ××©×ª×ª×¤×™× â€“ 130 ×©"×—
6 ××©×ª×ª×¤×™× â€“ 120 ×©"×—
7 ××©×ª×ª×¤×™× ×•××¢×œ×” â€“ 110 ×©"×—

××‘×¦×¢×™× ×•×”× ×—×•×ª:
â€“ 10% ×”× ×—×” ×œ×™×œ×“×™× ×¢×“ ×’×™×œ 12 (×‘×œ×™×•×•×™ ×©× ×™ ××‘×•×’×¨×™× ×œ×¤×—×•×ª, ××œ×•×•×” ×—×™×™×‘ ×‘×ª×©×œ×•×)
â€“ 20% ×”× ×—×” ×œ×—×•×’×’ ×™×•× ×”×•×œ×“×ª (×¨×§ ×œ×—×•×’×’, ×‘×©×‘×•×¢ ×”×”×•×œ×“×ª, ×‘×§×‘×•×¦×” ×©×œ 6+ ××©×ª×ª×¤×™×, ×”×˜×‘×ª ×™×•× ×”×•×œ×“×ª ××—×ª ×œ×§×‘×•×¦×”)
â€“ ×”× ×—×•×ª ×œ×—×™×™×œ×™×, ×¡×˜×•×“× ×˜×™× ×•×©×™×¨×•×ª ×œ××•××™ â€“ ×œ×¤×™ ×”××—×™×¨×•×Ÿ
â€“ ×›×œ ×”×”× ×—×•×ª ×‘×ª×•×§×£ ×‘×”×¦×’×ª ×ª×¢×•×“×” ××ª××™××” ×‘×œ×‘×“
â€“ ××™×Ÿ ×›×¤×œ ××‘×¦×¢×™× ×•×”× ×—×•×ª


    {sheet_data}
    """

def load_faq_data():
    global faq_data
    if not faq_data:
        faq_data = faq_worksheet.get_all_records()

def match_faq(user_question: str, threshold: float = FAQ_MATCH_THRESHOLD):
    load_faq_data()
    questions = [row["×©××œ×”"] for row in faq_data]
    matches = get_close_matches(user_question, questions, n=1, cutoff=threshold)
    if matches:
        match = matches[0]
        for row in faq_data:
            if row["×©××œ×”"] == match:
                return row["×ª×©×•×‘×”"], match
    return None

def get_sheet_data(sheet_name: str) -> str:
    if sheet_name in sheet_cache:
        return sheet_cache[sheet_name]
    try:
        ws = sheet.worksheet(sheet_name)
        rows = ws.get_all_values()
        data = f"-- {sheet_name} --\n" + "\n".join([" | ".join(r) for r in rows])
        sheet_cache[sheet_name] = data
        return data
    except Exception as e:
        print(f"âš ï¸ ×©×’×™××” ×‘×’×œ×™×•×Ÿ {sheet_name}: {e}")
        return ""

def try_load_valid_sheets(user_id: str, question: str):
    candidates = detect_relevant_sheets(user_id, question)
    valid, combined = [], []
    for sheet_name in candidates:
        data = get_sheet_data(sheet_name)
        if any(word in data for word in question.split()):
            valid.append(sheet_name)
            combined.append(data)
    if not valid:
        data = get_sheet_data(DEFAULT_SHEET)
        return [DEFAULT_SHEET], data
    return valid, "\n\n".join(combined)

def get_chat_history(user_id: str) -> list:
    if user_id in chat_cache:
        return chat_cache[user_id]
    raw = redis_client.get(f"chat:{user_id}")
    history = json.loads(raw) if raw else []
    chat_cache[user_id] = history
    return history[-8:]

def save_chat_history(user_id: str, history: list):
    trimmed = history[-8:]
    chat_cache[user_id] = trimmed
    redis_client.setex(f"chat:{user_id}", 3600, json.dumps(trimmed))

def detect_relevant_sheets(user_id: str, question: str) -> list:
    sheets = [room for room in ROOMS if room in question]
    if not sheets and any(word in question for word in GENERAL_KEYWORDS):
        return [DEFAULT_SHEET]
    if not sheets:
        sheets = [redis_client.get(f"last_sheet:{user_id}") or DEFAULT_SHEET]
    redis_client.setex(f"last_sheet:{user_id}", 3600, sheets[0])
    return sheets

def log_to_sheet(user_id, model, q, a, tokens, price_ils, sheet_name, source="GPT", match=""):
    try:
        log_worksheet.append_row([
            datetime.now().strftime("%Y-%m-%d %H:%M"),
            user_id, model,
            q[:300].replace("\n", " "),
            a.replace("\n", " "),
            tokens,
            f"â‚ª{price_ils}",
            sheet_name, source, match
        ])
    except Exception as e:
        print(f"âš ï¸ ×©×’×™××” ×‘×œ×•×’ ×œ×’×™×œ×™×•×Ÿ: {e}")

def ask_gpt(user_id: str, user_question: str, sheet_data: str, sheet_names: list) -> str:
    history = get_chat_history(user_id)
    history.append({"role": "user", "content": user_question})
    messages = [{"role": "system", "content": build_system_prompt(sheet_data)}] + history

    prompt_tokens = count_tokens(messages)
    completion_tokens = 1200
    total_tokens = prompt_tokens + completion_tokens

    model_name = "gpt-3.5-turbo"
    if total_tokens > MAX_TOKENS_GPT3:
        model_name = "gpt-4-turbo"
        prompt_tokens = count_tokens(messages, model=model_name)
        total_tokens = prompt_tokens + completion_tokens

    if total_tokens > MAX_TOKENS_GPT4:
        return "âš ï¸ ×”×©××œ×” ×•×”×”×§×©×¨ ××¨×•×›×™× ××“×™ ×œ-GPT-4-Turbo. × ×¡×” ×œ×§×¦×¨."

    try:
        response = openai_client.chat.completions.create(
            model=model_name,
            messages=messages,
            temperature=0.6,
            max_tokens=completion_tokens
        )
    except Exception as e:
        return f"âš ï¸ ×©×’×™××” ××”×©×¨×ª ×©×œ OpenAI: {str(e)}"

    answer = response.choices[0].message.content.strip().replace('"', '').replace('\n', ' ').replace('\r', ' ').strip()
    history.append({"role": "assistant", "content": answer})
    save_chat_history(user_id, history)

    redis_client.incrby(f"token_sum:{user_id}", total_tokens)
    redis_client.incrby(f"token_input:{user_id}", prompt_tokens)
    redis_client.incrby(f"token_output:{user_id}", completion_tokens)

    usd = (prompt_tokens * PRICING[model_name]["input"] + completion_tokens * PRICING[model_name]["output"]) / 1000
    price_ils = round(usd * ILS_CONVERSION, 2)
    log_to_sheet(user_id, model_name, user_question, answer, total_tokens, price_ils, ', '.join(sheet_names))
    return answer

@app.route("/webhook", methods=["POST"])
def webhook():
    try:
        data = request.get_json()
        user_question = data.get("message")
        user_id = data.get("user_id")

        if not user_question or not user_id:
            return jsonify({"error": "Missing 'message' or 'user_id'"}), 200

        if user_question.strip().lower() == "×¡×™×™× ×©×™×—×”":
            redis_client.delete(f"chat:{user_id}", f"token_sum:{user_id}", f"token_input:{user_id}", f"token_output:{user_id}")
            return jsonify({"reply": "×”×©×™×—×” ××•×¤×¡×” ×‘×”×¦×œ×—×” âœ…"})

        if user_question.strip() == "12345":
            try:
                total = int(redis_client.get(f"token_sum:{user_id}") or 0)
                input_toks = int(redis_client.get(f"token_input:{user_id}") or 0)
                output_toks = int(redis_client.get(f"token_output:{user_id}") or 0)
                model = "gpt-4-turbo" if total > MAX_TOKENS_GPT3 else "gpt-3.5-turbo"
                usd = ((input_toks * PRICING[model]["input"] + output_toks * PRICING[model]["output"]) / 1000)
                ils = round(usd * ILS_CONVERSION, 2)
            except Exception as e:
                total, ils = 0, 0
            return jsonify({"reply": f"ğŸ”¢ ×¡×š ×”×˜×•×§× ×™×: {total}\nğŸ’° ×¢×œ×•×ª ××©×•×¢×¨×ª: â‚ª{ils}"})

        match = match_faq(user_question)
        if match:
            answer, matched_question = match
            log_to_sheet(user_id, "FAQ", user_question, answer, 0, 0, DEFAULT_SHEET, source="FAQ", match=matched_question)
            return jsonify({"reply": answer})

        sheets, full_context = try_load_valid_sheets(user_id, user_question)
        if not full_context:
            return jsonify({"reply": "×©×’×™××”: ×œ× ×”×¦×œ×—× ×• ×œ×§×¨×•× ××™×“×¢ ×¨×œ×•×•× ×˜×™."})

        reply = ask_gpt(user_id, user_question, full_context, sheets)
        return jsonify({"reply": reply})

    except Exception as e:
        return jsonify({"error": "Internal Server Error", "details": str(e)}), 200

@app.route("/", methods=["GET"])
def index():
    return "âœ… WhatsApp GPT bot is alive"

if __name__ == "__main__":
    port = int(os.environ.get("PORT", 5000))
    app.run(host="0.0.0.0", port=port)
